#负载均衡
##为什么需要负载均衡（load balance）
现有网络的各个核心部分随着业务量的提高，访问量和数据量的快速增长，其处理能力和计算强丢也相应的增大，使得单一的服务器设备根本无法承担。在此情况下，如果扔掉现有设备去做大量的硬件升级，会造成现有资源的浪费，如果面临下一次业务量的提升时，这又将导致再一次硬件升级的高额成本投入，甚至性能再卓越的设备也不能满足当前业务量增长的需求。针对此情况而衍生出来的一种廉价有效透明的方法以扩展现有网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性的技术就是负载均衡（load balance）。

##HTTP负载均衡
通过一个HTTP重定向服务器来对请求进行重定向；

![](https://img-blog.csdn.net/20140721122831078?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

**优点**： 实现简单；
**缺点**： 浏览器需要两次请求服务器才能完成一次访问，性能较差；重定向服务器本身的处理能力可能成为瓶颈，整个集群的伸缩性规模有限；使用HTTP返回码302重定向，有可能使搜索引擎判断为SEO作弊，降低搜索排名。

##DNS负载均衡
**DNS**是域名和IP地址相互映射的一个分布式数据库，能够用域名找到对应的主机IP地址上。这使得DNS具有了负载均衡的功能。
在DNS系统中有一个比较重要的的资源类型叫做主机记录也称为**A记录**，A记录是用于名称解析的重要记录，它将特定的主机名映射到对应主机的IP地址上。

![](https://img-blog.csdn.net/20140721145326171?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

**优点**：
>* 将负载均衡的工作交给DNS，省去了网站管理维护负载均衡服务器的麻烦；
>* 技术实现比较灵活、方便，简单易行，成本低，适用于大多数TCP/IP应用；
>* 对于部署在服务器上的应用来说不需要任何的代码修改即可实现不同机器上的应用访问；
>* 服务器可以位于互联网的任意位置；
>* 同时许多DNS还支持基于地理位置的域名解析，即会将域名解析成距离用户地理最近的服务器地址，这样就可以加速用户访问，改善性能；

**缺点**：
>* 目前的DNS是多级解析的，每一级都可能缓存A记录，生效需要时间。如果下线了某台服务器，一段时间内，DNS仍然会将域名解析到已下线的服务器上，最终导致用户访问失败；
>* 不能够按服务器的能力来分配负载。DNS负载均衡采用的是简单的轮询算法，不能区分服务器之间的差异，不能反映服务器当前的运行状态，所以其的负载均衡效果并不是太好。
>* 可能会造成额外的网络问题。为了使本DNS服务器与其他DNS服务器及时交互，保证DNS数据及时更新，使地址能随机分配，一般要将DNS的刷新时间设置的较小，但太小会使DNS流量大增造成额外的网络问题。

大型网站一般会部分使用DNS域名解析，利用域名解析作为第一级负载均衡手段，及域名解析得到的一组服务器并不是实际提供服务的物理服务器，而是同样提供负载均衡服务的内部服务器，这组负载均衡服务器再进行负载均衡，请求发到真实的服务器上，最终完成请求。

##链路层负载均衡
**虚拟IP**通过TCP/IP的ARP协议实现。IP地址只是一个逻辑地址，在以太网中MAC地址才是真正用来进行数据传输的物理地址，每台主机中都有一个ARP高速缓存，存储同一个网络内的IP地址与MAC地址的对应关系。以太网中的主机发送数据时会先从这个缓存中查询目标IP对应的MAC地址，会向这个MAC地址发送数据。操作系统会自动维护这个缓存。这是实现虚拟IP的关键。

而链路层负载均衡通过修改通信协议数据包的mac地址进行负载均衡，负载均衡数据分发过程中不修改IP地址，只修改目的MAC地址，通过配置真实物理服务器集群所有机器虚拟IP和负载均衡服务器IP一致，从而达到不修改数据包的源地址和目的地址就可以进行数据分发的目的，由于实际处理请求的真实物理服务器IP和数据请求目的IP一致，不需要通过负载均衡服务器进行地址交换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈。
集群可以通过如下图的部署来达到负载均衡，这种传输方式又称为三角传输：

![](https://img-blog.csdn.net/20140723071239282?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)


 如上图所示，用户请求到达负载均衡服务器114.100.20.200后，负载均衡服务器将数据包的目的MAC地址更改为00:1e:ec:bc:5e:03，并不修改数据包目的IP，由于服务器集群所有服务器的**虚拟IP**地址和负载均衡服务器IP地址一致，因此数据可以正常传输到达MAC地址为00:1e:ec:bc:5e:03的机器上，该服务器处理完之后，将响应数据包发送到**网关服务器**，网关服务器直接将数据包发送给用户浏览器，响应数据不需要通过负载均衡服务器，这样就避免了负载均衡服务器成为传输瓶颈的可能。

 DR模式是目前使用最广泛的一种负载均衡方式；
 在Linux平台上最好的链路层负载均衡开源产品是LVS(Linux Virtual Server)。

 **优点**： 性能好；
 **缺点**： 配置复杂；

 ##IP负载（网络层）均衡
核心原理是通过内核驱动更改IP的目的地址来完成数据负载均衡；

![](https://img-blog.csdn.net/20140722102153244)

![](https://img-blog.csdn.net/20140722102011609?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

